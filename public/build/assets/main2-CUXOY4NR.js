$(document).ready(function(){const B=$("#data").data("id-latihan"),T=$("#data").data("id-bahasa"),w=$("#data").data("bahasa"),S=$("#data").data("kategori"),P=$("#data").data("bantuan-suara"),I=$("#data").data("bantuan-pengucapan"),v=$("#data").data("delay-bantuan"),b=$("#data").data("maks-salah");let r,p=0,f=0,u=0,h=0,l=[],A=[],c,x=[],L,K;function M(e){return parseInt(localStorage.getItem("idLatihan"))!==e}function d(){return l.findIndex(t=>t.kata===r.word)}M(B)?(E(),localStorage.setItem("idLatihan",B)):O();function m(){d()!==-1&&(l[d()].durasi=(new Date-K)/1e3,W())}window.onbeforeunload=function(){m()};function W(){localStorage.setItem("totalWords",p),localStorage.setItem("totalCorrect",f),localStorage.setItem("wordList",JSON.stringify(l))}function O(){p=parseInt(localStorage.getItem("totalWords"))||0,f=parseInt(localStorage.getItem("totalCorrect"))||0,l=JSON.parse(localStorage.getItem("wordList"))||[]}function E(){localStorage.removeItem("idLatihan"),localStorage.removeItem("totalWords"),localStorage.removeItem("totalCorrect"),localStorage.removeItem("wordList"),localStorage.clear()}function N(){$("#kata").text(r.word),$("#ejaan").text(r.pronunciation),$("#translatedWord").text(r.translation),$("#translatedIcon").show(),$("#offMic").show(),$("#skipSection").show(),u=0,h=0,K=new Date}function F(){return $("#spellingBtn").prop("disabled",!1),$("#translatedIcon").hide(),$("#spellingSection").hide(),$("#onMic").hide(),$("#spelledSection").hide(),$("#trueSection").hide(),$("#exampleSentenceSection").hide(),$("#correctSpellingAudio").hide(),p===0?$("#skipSection").hide():$("#skipSection").addClass("d-flex justify-content-center").show(),console.log(`${window.location.origin}/word/${w}/${S}`),new Promise((e,t)=>{$.ajax({type:"post",url:`${window.location.origin}/word/${w}/${S}`,success:function(a){r=a[0],p++,l.push({kata:r.word,cara_baca:r.pronunciation,terjemahan:r.translation,percobaan:0,benar:0,durasi:0}),A.push(r.word),W(),e(r)},error:function(a,n,i){console.error(a.responseText),t(i)}})})}function k(e=1){const a=new FormData;return a.append("kata",r.word),a.append("idBahasa",T),a.append("bantuanSuara",P),new Promise((n,i)=>{$.ajax({type:"post",url:`${window.location.origin}/text-to-speech`,data:a,processData:!1,contentType:!1,success:function(o){const g=o.audio_url;fetch(g).then(s=>{if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return s.blob()}).then(s=>{const y=new Audio(URL.createObjectURL(s)),Y=$("#correctSpellingAudio");y.controls=!0,Y.html(y),y.play().catch(H=>{console.error("Audio playback failed:",H)}),n()}).catch(s=>{console.error("Audio load failed:",s),e<5?setTimeout(()=>k(e+1).then(n).catch(i),1e3):i()})},error:function(o){console.error(`Attempt ${e} failed:`,o.responseText),e<5?setTimeout(()=>k(e+1).then(n).catch(i),1e3):i()}})})}function q(){navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{c=new MediaRecorder(e,{mimeType:"audio/webm"}),c.start(),c.ondataavailable=t=>{x.push(t.data)},c.onstop=()=>{const t=new Blob(x,{type:"audio/webm"}),a=new FormData;a.append("audio",t,"audio.webm"),a.append("languageId",T),a.append("speechContext",JSON.stringify(A)),$.ajax({type:"POST",url:`${window.location.origin}/speech-to-text`,data:a,processData:!1,contentType:!1,success:function(n){const i=n.transcription;let o=i[0],g=!1;for(let s=0;s<i.length;s++)if(U(i[s])){o=i[s],g=!0;break}o==null||o==""?Swal.fire({title:"Kesalahan!",text:"Ucapanmu tidak terdengar dengan jelas, coba ucapkan kata secara perlahan! Ini tidak akan dihitung sebagai kesalahan.",icon:"warning"}):($("#spelledWord").text(o.replace(/[\p{P}\p{S}]+$/u,"")),$("#spelledWord").removeClass("text-success text-danger"),u++);try{g?($("#spelledSection").show(),R("correct"),u<=b&&(f++,d()!==-1&&(l[d()].benar=1)),d()!==-1&&(l[d()].percobaan=u),$("#spelledWord").addClass("text-success"),$("#spellingSection").hide(),$("#trueSection").show(),$("#exampleSentenceSection").show(),$("#skipSection").removeClass("d-flex justify-content-center"),$("#skipSection").hide()):(R("wrong"),$("#spellingBtn").prop("disabled",!1),$("#spelledSection").show(),(o==null||o=="")&&$("#spelledSection").hide(),h++,$("#spelledWord").addClass("text-danger"),$("#spellingSection").show(),$("#exampleSentenceSection").hide(),h==v&&I==!0&&$("#correctSpellingAudio").show(),u==b&&Swal.fire({title:"Batas kesalahan tercapai!",html:"Kamu sudah mencapai batas maksimum kesalahan.<br>Kalau salah lagi, kata ini akan dianggap salah.",icon:"warning",confirmButtonText:"OK"}),u==b+1&&Swal.fire({title:"Kata masih salah!",html:"Kamu masih salah.<br>Kamu boleh terus mencoba, tapi kata ini akan dianggap salah walaupun sudah benar. Semangat!",icon:"info",confirmButtonText:"OK"}),d()!==-1&&(l[d()].percobaan=u))}catch(s){console.error(s),$("#spelledSection").hide(),$("#spellingBtn").prop("disabled",!1)}},error:function(n,i,o){n.responseText.includes("error")&&Swal.fire({title:"Kesalahan!",text:"Koneksi internet terputus!",icon:"warning"}),console.error(n.responseText,i,o),$("#spellingBtn").prop("disabled",!1)}}),x=[]},L=setTimeout(()=>{j(),$("#spellingBtn").prop("disabled",!0)},2e3)}).catch(e=>console.error("Error accessing media devices.",e),$("#spellingBtn").prop("disabled",!1))}function j(){clearTimeout(L),c.stop(),$("#onMic").hide(),$("#offMic").show()}$("#spellingBtn").on("click",function(){!c||c.state==="inactive"?(q(),$("#onMic").show(),$("#offMic").hide()):c.state==="recording"&&j()});function D(e){return e.normalize("NFKC").replace(/[^\p{L}\p{N}\s]/gu,"").replace(/\s+/g,"").toLowerCase()}function U(e){const t=D(r.word),a=D(e);return t===a}function R(e){let t;e==="correct"?t="/audio/correct.mp3":e==="wrong"&&(t="/audio/wrong.mp3"),new Audio(t).play().catch(n=>{console.error("Audio playback failed:",n)})}function z(){const e=new FormData;return e.append("kata",r.word),e.append("terjemahan",r.translation),e.append("bahasa",w),e.append("kategori",S),new Promise((t,a)=>{$.ajax({type:"post",url:`${window.location.origin}/example-sentences`,data:e,processData:!1,contentType:!1,success:function(n){J(n),t(n)},error:function(n,i,o){console.error(n.responseText),a(o)}})})}function J(e){const t=$("#exampleSentencesCarousel");t.empty(),e!==null&&e.forEach((a,n)=>{const o=`<div class="carousel-item ${n===0?"active":""} text-center">
                        <blockquote class="blockquote mb-0">
                            <p>${a.sentence}</p>
                            <footer class="blockquote-footer">
                                ${a.translation}
                            </footer>
                        </blockquote>
                    </div>`;t.append(o)})}function _(e=!1){Swal.fire({title:"Selesai Latihan?",html:e===!1?"Ingin menyelesaikan latihan ini?<br>Kata ini akan dianggap salah.":"Ingin menyelesaikan latihan ini?",icon:"question",showCancelButton:!0,confirmButtonColor:"#198754",cancelButtonColor:"#DC3545",confirmButtonText:"Iya",cancelButtonText:"Batal"}).then(t=>{if(t.isConfirmed){m();const a=$("#latihanForm");$("#jumlah_kata").val(p),$("#jumlah_benar").val(f),$("#list").val(JSON.stringify(l)),a.submit()}})}$("#nextBtn").on("click",function(){m(),C()}),$("#skipBtn").on("click",function(){m(),Swal.fire({title:"Lewati Kata Ini?",html:"Yakin melewati kata ini?<br>Kata ini akan dianggap salah.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#198754",cancelButtonColor:"#DC3545",confirmButtonText:"Ya, lewati!",cancelButtonText:"Batal"}).then(e=>{e.isConfirmed&&C()})});function C(){$("#loading").addClass("d-flex justify-content-center full-screen").show(),F().then(N).then(()=>$("#loading").removeClass("full-screen")).then(z).then(()=>k()).then(()=>$("#spellingSection").show()).then(()=>$("#loading").removeClass("d-flex justify-content-center").hide()).then(()=>{h==v&&I==!0&&$("#correctSpellingAudio").show()})}C(),window.saveResults=_});
