$(document).ready(function(){const C=$("#data").data("id-latihan"),y=$("#data").data("id-bahasa"),B=$("#data").data("bahasa"),D=$("#data").data("kategori"),P=$("#data").data("bantuan-suara"),T=$("#data").data("bantuan-pengucapan"),I=$("#data").data("delay-bantuan"),w=$("#data").data("maks-salah");let l,p=0,f=0,d=0,h=0,s=[],v=[],c,S=[],A,L;function M(e){return parseInt(localStorage.getItem("idLatihan"))!==e}function u(){return s.findIndex(a=>a.kata===l.word)}M(C)?(N(),localStorage.setItem("idLatihan",C)):O();function m(){u()!==-1&&(s[u()].durasi=(new Date-L)/1e3,K())}window.onbeforeunload=function(){m()};function K(){localStorage.setItem("totalWords",p),localStorage.setItem("totalCorrect",f),localStorage.setItem("wordList",JSON.stringify(s))}function O(){p=parseInt(localStorage.getItem("totalWords"))||0,f=parseInt(localStorage.getItem("totalCorrect"))||0,s=JSON.parse(localStorage.getItem("wordList"))||[]}function N(){localStorage.removeItem("idLatihan"),localStorage.removeItem("totalWords"),localStorage.removeItem("totalCorrect"),localStorage.removeItem("wordList"),localStorage.clear()}function E(){$("#kata").text(l.word),$("#ejaan").text(l.pronunciation),$("#translatedWord").text(l.translation),$("#translatedIcon").show(),$("#offMic").show(),$("#skipSection").show(),d=0,h=0,L=new Date}function U(){return $("#spellingBtn").prop("disabled",!1),$("#translatedIcon").hide(),$("#spellingSection").hide(),$("#onMic").hide(),$("#spelledSection").hide(),$("#trueSection").hide(),$("#exampleSentenceSection").hide(),$("#correctSpellingAudio").hide(),$("#skipSection").addClass("d-flex justify-content-center"),new Promise((e,a)=>{$.ajax({type:"post",url:`${window.location.origin}/word/${B}/${D}`,success:function(t){l=t[0],p++,s.push({kata:l.word,cara_baca:l.pronunciation,terjemahan:l.translation,percobaan:0,benar:0,durasi:0}),v.push(l.word),K(),e(l)},error:function(t,o,n){console.error(t.responseText),a(n)}})})}function x(e=1){const t=new FormData;return t.append("kata",l.word),t.append("idBahasa",y),t.append("bantuanSuara",P),new Promise((o,n)=>{$.ajax({type:"post",url:`${window.location.origin}/text-to-speech`,data:t,processData:!1,contentType:!1,success:function(i){const g=i.audio_url;fetch(g).then(r=>{if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.blob()}).then(r=>{const k=new Audio(URL.createObjectURL(r)),Y=$("#correctSpellingAudio");k.controls=!0,Y.html(k),k.play().catch(H=>{console.error("Audio playback failed:",H)}),o()}).catch(r=>{console.error("Audio load failed:",r),e<5?setTimeout(()=>x(e+1).then(o).catch(n),1e3):n()})},error:function(i){console.error(`Attempt ${e} failed:`,i.responseText),e<5?setTimeout(()=>x(e+1).then(o).catch(n),1e3):n()}})})}function q(){navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{c=new MediaRecorder(e,{mimeType:"audio/webm"}),c.start(),c.ondataavailable=a=>{S.push(a.data)},c.onstop=()=>{const a=new Blob(S,{type:"audio/webm"}),t=new FormData;t.append("audio",a,"audio.webm"),t.append("languageId",y),t.append("speechContext",JSON.stringify(v)),$.ajax({type:"POST",url:`${window.location.origin}/speech-to-text`,data:t,processData:!1,contentType:!1,success:function(o){const n=o.transcription;let i=n[0],g=!1;for(let r=0;r<n.length;r++)if(F(n[r])){i=n[r],g=!0;break}i==null||i==""?Swal.fire({title:"Kesalahan!",text:"Ucapanmu tidak terdengar dengan jelas, coba ucapkan kata secara perlahan!",icon:"warning"}):($("#spelledWord").text(i.replace(/[\p{P}\p{S}]+$/u,"")),$("#spelledWord").removeClass("text-success text-danger"),d++);try{g?($("#spelledSection").show(),R("correct"),d<=w&&(f++,u()!==-1&&(s[u()].benar=1)),$("#spelledWord").addClass("text-success"),$("#spellingSection").hide(),$("#trueSection").show(),$("#exampleSentenceSection").show(),$("#skipSection").removeClass("d-flex justify-content-center"),$("#skipSection").hide()):(R("wrong"),$("#spellingBtn").prop("disabled",!1),$("#spelledSection").show(),(i==null||i=="")&&$("#spelledSection").hide(),h++,$("#spelledWord").addClass("text-danger"),$("#spellingSection").show(),$("#exampleSentenceSection").hide(),h==I&&T==!0&&$("#correctSpellingAudio").show(),d==w&&Swal.fire({title:"Batas kesalahan tercapai!",html:"Kamu sudah mencapai batas maksimum kesalahan.<br>Kalau salah lagi, kata ini akan dianggap salah.",icon:"warning",confirmButtonText:"OK"}),d==w+1&&Swal.fire({title:"Kata masih salah!",html:"Kamu masih salah.<br>Kamu boleh terus mencoba, tapi kata ini akan dianggap salah walaupun sudah benar. Semangat!",icon:"info",confirmButtonText:"OK"}),u()!==-1&&(s[u()].percobaan=d),m())}catch(r){console.error(r),$("#spelledSection").hide(),$("#spellingBtn").prop("disabled",!1)}},error:function(o,n,i){o.responseText.includes("error")&&Swal.fire({title:"Kesalahan!",text:"Koneksi internet terputus!",icon:"warning"}),console.error(o.responseText,n,i),$("#spellingBtn").prop("disabled",!1)}}),S=[]},A=setTimeout(()=>{W(),$("#spellingBtn").prop("disabled",!0)},2e3)}).catch(e=>console.error("Error accessing media devices.",e),$("#spellingBtn").prop("disabled",!1))}function W(){clearTimeout(A),c.stop(),$("#onMic").hide(),$("#offMic").show()}$("#spellingBtn").on("click",function(){!c||c.state==="inactive"?(q(),$("#onMic").show(),$("#offMic").hide()):c.state==="recording"&&W()});function j(e){return e.normalize("NFKC").replace(/[^\p{L}\p{N}\s]/gu,"").replace(/\s+/g,"").toLowerCase()}function F(e){const a=j(l.word),t=j(e);return a===t}function R(e){let a;e==="correct"?a="/audio/correct.mp3":e==="wrong"&&(a="/audio/wrong.mp3"),new Audio(a).play().catch(o=>{console.error("Audio playback failed:",o)})}function z(){return new Promise((e,a)=>{$.ajax({type:"post",url:`${window.location.origin}/example-sentences/${B}/${encodeURIComponent(l.word)}`,success:function(t){J(t),e(t)},error:function(t,o,n){console.error(t.responseText),a(n)}})})}function J(e){const a=$("#exampleSentencesCarousel");a.empty(),e!==null&&e.forEach((t,o)=>{const i=`<div class="carousel-item ${o===0?"active":""} text-center">
                        <blockquote class="blockquote mb-0">
                            <p>${t.sentence}</p>
                            <footer class="blockquote-footer">
                                ${t.translation}
                            </footer>
                        </blockquote>
                    </div>`;a.append(i)})}function _(e=!1){Swal.fire({title:"Selesai Latihan?",html:e===!1?"Ingin menyelesaikan latihan ini?<br>Kata ini akan dianggap salah.":"Ingin menyelesaikan latihan ini?",icon:"question",showCancelButton:!0,confirmButtonColor:"#198754",cancelButtonColor:"#DC3545",confirmButtonText:"Iya",cancelButtonText:"Batal"}).then(a=>{if(a.isConfirmed){m();const t=$("#latihanForm");$("#jumlah_kata").val(p),$("#jumlah_benar").val(f),$("#list").val(JSON.stringify(s)),t.submit()}})}$("#nextBtn").on("click",function(){b()}),$("#skipBtn").on("click",function(){m(),Swal.fire({title:"Lewati Kata Ini?",html:"Yakin melewati kata ini?<br>Kata ini akan dianggap salah.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#198754",cancelButtonColor:"#DC3545",confirmButtonText:"Ya, lewati!",cancelButtonText:"Batal"}).then(e=>{e.isConfirmed&&b()})});function b(){$("#loading").addClass("d-flex justify-content-center full-screen").show(),U().then(E).then(()=>$("#loading").removeClass("full-screen")).then(z).then(()=>x()).then(()=>$("#spellingSection").show()).then(()=>$("#loading").removeClass("d-flex justify-content-center").hide()).then(()=>{h==I&&T==!0&&$("#correctSpellingAudio").show()}).catch(()=>{console.error("Text-to-Speech gagal setelah 5 kali percobaan."),$("#spellingSection").show()})}b(),window.saveResults=_});
