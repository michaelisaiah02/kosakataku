$(document).ready(function(){const x=$("#data").data("id-latihan"),k=$("#data").data("id-bahasa"),C=$("#data").data("bahasa"),A=$("#data").data("kategori"),D=$("#data").data("bantuan-suara"),y=$("#data").data("bantuan-pengucapan"),B=$("#data").data("delay-bantuan"),g=$("#data").data("maks-salah");let n,p=0,f=0,d=0,m=0,r=[],I=[],s,w=[],T,v;function M(e){return parseInt(localStorage.getItem("idLatihan"))!==e}function u(){return r.findIndex(a=>a.kata===n.word)}M(x)?(U(),localStorage.setItem("idLatihan",x)):O();function h(){u()!==-1&&(r[u()].durasi=(new Date-v)/1e3,K())}window.onbeforeunload=function(){h()};function K(){localStorage.setItem("totalWords",p),localStorage.setItem("totalCorrect",f),localStorage.setItem("wordList",JSON.stringify(r))}function O(){p=parseInt(localStorage.getItem("totalWords"))||0,f=parseInt(localStorage.getItem("totalCorrect"))||0,r=JSON.parse(localStorage.getItem("wordList"))||[]}function U(){localStorage.removeItem("idLatihan"),localStorage.removeItem("totalWords"),localStorage.removeItem("totalCorrect"),localStorage.removeItem("wordList"),localStorage.clear()}function S(){$("#kata").text(n.word),$("#ejaan").text(n.pronunciation),$("#translatedWord").text(n.translation),$("#translatedIcon").show(),$("#spellingSection").show(),$("#offMic").show(),$("#skipSection").show(),$("#loading").removeClass("d-flex justify-content-center"),$("#loading").hide(),m==B&&y==!0&&$("#correctSpellingAudio").show(),E(n.word),d=0,m=0,v=new Date}function b(){return $("#loading").show(),$("#loading").addClass("d-flex justify-content-center"),$("#spellingBtn").prop("disabled",!1),$("#translatedIcon").hide(),$("#spellingSection").hide(),$("#onMic").hide(),$("#spelledSection").hide(),$("#trueSection").hide(),$("#exampleSentenceSection").hide(),$("#correctSpellingAudio").hide(),$("#skipSection").addClass("d-flex justify-content-center"),new Promise((e,a)=>{$.ajax({type:"post",url:`${window.location.origin}/word/${encodeURIComponent(C)}/${encodeURIComponent(A)}`,success:function(t){n=t[0],p++,r.push({kata:n.word,cara_baca:n.pronunciation,terjemahan:n.translation,percobaan:0,benar:0,durasi:0}),I.push(n.word),N(),K(),e(n)},error:function(t,o,i){console.error(t.responseText),a(i)}})})}function N(){const e=new FormData;e.append("kata",n.word),e.append("idBahasa",k),e.append("bantuanSuara",D),$.ajax({type:"post",url:`${window.location.origin}/text-to-speech`,data:e,processData:!1,contentType:!1,cache:!1,success:function(a){const t=a.audio_url,o=new Audio(t),i=$("#correctSpellingAudio");o.controls=!0,i.html(o),o.play().catch(l=>{console.error("Audio playback failed:",l)}),i.show()},error:function(a){console.error(a.responseText)}})}function P(){navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{s=new MediaRecorder(e,{mimeType:"audio/webm"}),s.start(),s.ondataavailable=a=>{w.push(a.data)},s.onstop=()=>{const a=new Blob(w,{type:"audio/webm"}),t=new FormData;t.append("audio",a,"audio.webm"),t.append("languageId",k),t.append("speechContext",JSON.stringify(I)),$.ajax({type:"POST",url:`${window.location.origin}/speech-to-text`,data:t,processData:!1,contentType:!1,success:function(o){const i=o.transcription;let l=i[0],R=!1;for(let c=0;c<i.length;c++)if(q(i[c])){l=i[c],R=!0;break}$("#spelledWord").text(l),$("#spelledWord").removeClass("text-success text-danger"),$("#spelledSection").show(),d++;try{R?(j("correct"),d<=g&&(f++,u()!==-1&&(r[u()].benar=1)),$("#spelledWord").addClass("text-success"),$("#spellingSection").hide(),$("#trueSection").show(),$("#exampleSentenceSection").show(),$("#skipSection").removeClass("d-flex justify-content-center"),$("#skipSection").hide()):(j("wrong"),m++,$("#spelledWord").addClass("text-danger"),$("#spellingSection").show(),$("#spellingBtn").prop("disabled",!1),$("#exampleSentenceSection").hide(),m==B&&y==!0&&$("#correctSpellingAudio").show(),d==g&&Swal.fire({title:"Batas kesalahan tercapai!",html:"Kamu sudah mencapai batas maksimum kesalahan.<br>Kalau salah lagi, kata ini akan dianggap salah.",icon:"warning",confirmButtonText:"OK"}),d==g+1&&Swal.fire({title:"Kata masih salah!",html:"Kamu masih salah.<br>Kamu boleh terus mencoba, tapi kata ini akan dianggap salah walaupun sudah benar. Semangat!",icon:"info",confirmButtonText:"OK"})),u()!==-1&&(r[u()].percobaan=d),h()}catch(c){console.error(c),c instanceof TypeError&&Swal.fire({title:"Kesalahan!",text:"Ucapanmu tidak terdengar dengan jelas, coba ucapkan kata secara perlahan!",icon:"warning"}),$("#spelledSection").hide(),$("#spellingBtn").prop("disabled",!1)}},error:function(o,i,l){o.responseText.includes("error")&&Swal.fire({title:"Kesalahan!",text:"Koneksi internet terputus!",icon:"warning"}),console.error(o.responseText,i,l),$("#spellingBtn").prop("disabled",!1)}}),w=[]},T=setTimeout(()=>{L(),$("#spellingBtn").prop("disabled",!0)},2e3)}).catch(e=>console.error("Error accessing media devices.",e),$("#spellingBtn").prop("disabled",!1))}function L(){clearTimeout(T),s.stop(),$("#onMic").hide(),$("#offMic").show()}$("#spellingBtn").on("click",function(){!s||s.state==="inactive"?(P(),$("#onMic").show(),$("#offMic").hide()):s.state==="recording"&&L()});function W(e){return e.normalize("NFKC").replace(/\s+/g,"").toLowerCase()}function q(e){return W(n.word)===W(e)}function j(e){let a;e==="correct"?a="/audio/correct.mp3":e==="wrong"&&(a="/audio/wrong.mp3"),new Audio(a).play().catch(o=>{console.error("Audio playback failed:",o)})}function E(){return new Promise((e,a)=>{$.ajax({type:"post",url:`${window.location.origin}/example-sentences/${encodeURIComponent(C)}/${encodeURIComponent(n.word)}`,success:function(t){F(t),e(t)},error:function(t,o,i){console.error(t.responseText),a(i)}})})}function F(e){const a=$("#exampleSentencesCarousel");a.empty(),e!==null&&e.forEach((t,o)=>{const l=`<div class="carousel-item ${o===0?"active":""} text-center">
                        <blockquote class="blockquote mb-0">
                            <p>${t.sentence}</p>
                            <footer class="blockquote-footer">
                                ${t.translation}
                            </footer>
                        </blockquote>
                    </div>`;a.append(l)})}function J(e=!1){Swal.fire({title:"Selesai Latihan?",html:e===!1?"Ingin menyelesaikan latihan ini?<br>Kata ini akan dianggap salah.":"Ingin menyelesaikan latihan ini?",icon:"question",showCancelButton:!0,confirmButtonColor:"#198754",cancelButtonColor:"#DC3545",confirmButtonText:"Iya",cancelButtonText:"Batal"}).then(a=>{if(a.isConfirmed){h();const t=$("#latihanForm");$("#jumlah_kata").val(p),$("#jumlah_benar").val(f),$("#list").val(JSON.stringify(r)),t.submit()}})}$("#nextBtn").on("click",function(){b().then(S)}),$("#skipBtn").on("click",function(){h(),Swal.fire({title:"Lewati Kata Ini?",html:"Yakin melewati kata ini?<br>Kata ini akan dianggap salah.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#198754",cancelButtonColor:"#DC3545",confirmButtonText:"Ya, lewati!",cancelButtonText:"Batal"}).then(e=>{e.isConfirmed&&b().then(S)})}),b().then(S),window.saveResults=J});
